# PhotoCrop — пример реализации обрезки изображений

Стек: TypeScript, React, SCSS, Vite, Jest, Express, Multer, Sharp.
Конфиг: dotenv
Тулсет: ESLint, Prettier, Husky, lint-staged

## Описание

Приложение позволяет загрузить изображение и обрезать его. После обрезки можно сохранить результат в виде изображения.

![preview.png](preview.png)

# Инструкции
Рекомендуется использовать пакетный менеджер Yarn, но можно использовать и npm. В репозитории добавлен файл настройки `.yarnrc.yml` устанавливающий `nodeLinker` в значение `node-modules`. Это позволяет установить зависимости в папку `node_modules` вместо папки `.yarn`. Это сделано для удобства работы с Vite.

## Запуск (сначала backend, потом frontend)

Сервер по-умолчанию запускается на порту 3000. При необходимости можно изменить порт в файле `.env`.
Фронтенд проксирует запросы на сервер с префиксом `/api`. По-умолчанию проксируется на `http://localhost:3000`, изменить можно в файле `vite.config.ts`.

```bash
npm install
npm run dev
```

## Сборка

```bash
npm run build
```

## Тесты (только на фронте)

```bash
npm run test
```

# Структура проекта

```
.
├── backend/ - сервер
│   ├── .uploads/ [Папка для загруженных изображений]
│   ├── .bin/
│   │   ├── clear.sh [Скрипт для очистки папки .uploads]
│   ├── src/
│   │   ├── lib/
│   │   │   ├── types.ts [Типы и схемы Joi для валидации запросов]
│   │   │   ├── image.ts [Реализация обрезки изображения через Sharp]
│   │   │   └── task.ts [Реализация очереди задач для обрезки изображений]
│   │   ├── routes/
│   │   │   ├── crop.ts [Реализация ручек для обрезки изображений]
│   │   │   └── upload.ts [Реализация ручки для загрузки изображения]
│   │   ├── config.ts [Конфигурация сервера]
│   │   ├── global.d.ts [Расширение глобального объекта Node.js для поддержки process.env]
│   │   └── index.ts [Express сервер]
│   ├── .env
│   ├── api.yaml [Спецификация API]
├── frontend/ - клиент
│   ├── tests/
│   │   ├── box.test.ts [Тесты для box.ts]
│   ├── src/
│   │   ├── styles/
│   │   │   ├── _variables.scss [Переменные SCSS]
│   │   ├── utils/
│   │   │   ├── box.ts [Реализация математики для обрезки изображения]
│   │   ├── components/
│   │   │   ├── App/
│   │   │   │   ├── App.tsx [Собранный кроппер]
│   │   ├── index.scss [Глобальные стили]
│   │   ├── main.tsx [Точка входа]
│   ├── .env
│   └── vite.config.ts [Конфигурация Vite + Proxy на сервер]
└── README.md
```

# Структура API

Смотри в файле `backend/api.yaml`.

# Структура компонент UI (C3)

```
App [Сборка кроппера]
  Cropper(file, state, dispatch) [Кроппер для одного файла]
    FileUpload(value, onChange) [Загрузка изображения]
        DropZone(isDragging, error, onDrop, onChange) [Зона для перетаскивания]
    ImagePreview(file) [Предпросмотр изображения]
    Resizer(value, onChange) [Редактор для обрезки]
  Selector(selected, onChange) [Селектор для выбора файла]
    ImagePreview(file) [Предпросмотр изображения]
  Actions(items) [Кнопки для сохранения и сброса]
```

# Что изменено по сравнению с версией для одного файла

1. Добавлена работа с несколькими файлами.
2. Есть прогресс загрузки изображений (можно проверить через DevTools с включенным throttle).
3. Добавлена пакетная обработка изображений на сервере и скачивание архива с результатами.

# Известные проблемы и что можно улучшить

1. Слабая обработка ошибок на сервере. В случае ошибки сервер просто падает.
2. Нет обработки ошибок на фронте. В случае ошибки сервера пользователь не получит никакого уведомления.
3. Нужно завернуть сервер в Docker контейнер для удобства последующего деплоя.